"""
Reference model
===============

This module defines the reference systems for the D3 model to compute the
C6 dispersion coefficients.

Example
-------
>>> numbers = jnp.array([7, 1, 1, 1])
>>> ref = Reference.from_numbers(numbers)
>>> ref.cn.shape
(4, 5)
>>> ref.c6.shape
(4, 4, 5, 5)
"""

import os.path as op
import jax.numpy as jnp
from .typing import Array


def _load_cn(dtype=jnp.float32) -> Array:
    return jnp.array(
        [
            [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # None
            [+0.9118, +0.0000, -1.0000, -1.0000, -1.0000],  # H
            [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # He
            [+0.0000, +0.9865, -1.0000, -1.0000, -1.0000],  # Li
            [+0.0000, +0.9808, +1.9697, -1.0000, -1.0000],  # Be
            [+0.0000, +0.9706, +1.9441, +2.9128, +4.5856],  # B
            [+0.0000, +0.9868, +1.9985, +2.9987, +3.9844],  # C
            [+0.0000, +0.9944, +2.0143, +2.9903, -1.0000],  # N
            [+0.0000, +0.9925, +1.9887, -1.0000, -1.0000],  # O
            [+0.0000, +0.9982, -1.0000, -1.0000, -1.0000],  # F
            [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Ne
            [+0.0000, +0.9684, -1.0000, -1.0000, -1.0000],  # Na
            [+0.0000, +0.9628, +1.9496, -1.0000, -1.0000],  # Mg
            [+0.0000, +0.9648, +1.9311, +2.9146, -1.0000],  # Al
            [+0.0000, +0.9507, +1.9435, +2.9407, +3.8677],  # Si
            [+0.0000, +0.9947, +2.0102, +2.9859, -1.0000],  # P
            [+0.0000, +0.9948, +1.9903, -1.0000, -1.0000],  # S
            [+0.0000, +0.9972, -1.0000, -1.0000, -1.0000],  # Cl
            [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Ar
            [+0.0000, +0.9767, -1.0000, -1.0000, -1.0000],  # K
            [+0.0000, +0.9831, +1.9349, -1.0000, -1.0000],  # Ca
            [+0.0000, +1.8627, +2.8999, -1.0000, -1.0000],  # Sc
            [+0.0000, +1.8299, +3.8675, -1.0000, -1.0000],  # Ti
            [+0.0000, +1.9138, +2.9110, -1.0000, -1.0000],  # V
            [+0.0000, +1.8269, 10.6191, -1.0000, -1.0000],  # Cr
            [+0.0000, +1.6406, +9.8849, -1.0000, -1.0000],  # Mn
            [+0.0000, +1.6483, +9.1376, -1.0000, -1.0000],  # Fe
            [+0.0000, +1.7149, +2.9263, +7.7785, -1.0000],  # Co
            [+0.0000, +1.7937, +6.5458, +6.2918, -1.0000],  # Ni
            [+0.0000, +0.9576, -1.0000, -1.0000, -1.0000],  # Cu
            [+0.0000, +1.9419, -1.0000, -1.0000, -1.0000],  # Zn
            [+0.0000, +0.9601, +1.9315, +2.9233, -1.0000],  # Ga
            [+0.0000, +0.9434, +1.9447, +2.9186, +3.8972],  # Ge
            [+0.0000, +0.9889, +1.9793, +2.9709, -1.0000],  # As
            [+0.0000, +0.9901, +1.9812, -1.0000, -1.0000],  # Se
            [+0.0000, +0.9974, -1.0000, -1.0000, -1.0000],  # Br
            [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Kr
            [+0.0000, +0.9738, -1.0000, -1.0000, -1.0000],  # Rb
            [+0.0000, +0.9801, +1.9143, -1.0000, -1.0000],  # Sr
            [+0.0000, +1.9153, +2.8903, -1.0000, -1.0000],  # Y
            [+0.0000, +1.9355, +3.9106, -1.0000, -1.0000],  # Zr
            [+0.0000, +1.9545, +2.9225, -1.0000, -1.0000],  # Nb
            [+0.0000, +1.9420, 11.0556, -1.0000, -1.0000],  # Mo
            [+0.0000, +1.6682, +9.5402, -1.0000, -1.0000],  # Tc
            [+0.0000, +1.8584, +8.8895, -1.0000, -1.0000],  # Ru
            [+0.0000, +1.9003, +2.9696, -1.0000, -1.0000],  # Rh
            [+0.0000, +1.8630, +5.7095, -1.0000, -1.0000],  # Pd
            [+0.0000, +0.9679, -1.0000, -1.0000, -1.0000],  # Ag
            [+0.0000, +1.9539, -1.0000, -1.0000, -1.0000],  # Cd
            [+0.0000, +0.9633, +1.9378, +2.9353, -1.0000],  # In
            [+0.0000, +0.9514, +1.9505, +2.9259, +3.9123],  # Sn
            [+0.0000, +0.9749, +1.9523, +2.9315, -1.0000],  # Sb
            [+0.0000, +0.9811, +1.9639, -1.0000, -1.0000],  # Te
            [+0.0000, +0.9968, -1.0000, -1.0000, -1.0000],  # I
            [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Xe
            [+0.0000, +0.9909, -1.0000, -1.0000, -1.0000],  # Cs
            [+0.0000, +0.9797, +1.8467, -1.0000, -1.0000],  # Ba
            [+0.0000, +1.9373, +2.9175, -1.0000, -1.0000],  # La
            [+2.7991, -1.0000, -1.0000, -1.0000, -1.0000],  # Ce
            [+0.0000, +2.9425, -1.0000, -1.0000, -1.0000],  # Pr
            [+0.0000, +2.9455, -1.0000, -1.0000, -1.0000],  # Nd
            [+0.0000, +2.9413, -1.0000, -1.0000, -1.0000],  # Pm
            [+0.0000, +2.9300, -1.0000, -1.0000, -1.0000],  # Sm
            [+0.0000, +1.8286, -1.0000, -1.0000, -1.0000],  # Eu
            [+0.0000, +2.8732, -1.0000, -1.0000, -1.0000],  # Gd
            [+0.0000, +2.9086, -1.0000, -1.0000, -1.0000],  # Tb
            [+0.0000, +2.8965, -1.0000, -1.0000, -1.0000],  # Dy
            [+0.0000, +2.9242, -1.0000, -1.0000, -1.0000],  # Ho
            [+0.0000, +2.9282, -1.0000, -1.0000, -1.0000],  # Er
            [+0.0000, +2.9246, -1.0000, -1.0000, -1.0000],  # Tm
            [+0.0000, +2.8482, -1.0000, -1.0000, -1.0000],  # Yb
            [+0.0000, +2.9219, -1.0000, -1.0000, -1.0000],  # Lu
            [+0.0000, +1.9254, +3.8840, -1.0000, -1.0000],  # Hf
            [+0.0000, +1.9459, +2.8988, -1.0000, -1.0000],  # Ta
            [+0.0000, +1.9292, 10.9153, -1.0000, -1.0000],  # W
            [+0.0000, +1.8104, +9.8054, -1.0000, -1.0000],  # Re
            [+0.0000, +1.8858, +9.1527, -1.0000, -1.0000],  # Os
            [+0.0000, +1.8648, +2.9424, -1.0000, -1.0000],  # Ir
            [+0.0000, +1.9188, +6.6669, -1.0000, -1.0000],  # Pt
            [+0.0000, +0.9846, -1.0000, -1.0000, -1.0000],  # Au
            [+0.0000, +1.9896, -1.0000, -1.0000, -1.0000],  # Hg
            [+0.0000, +0.9267, +1.9302, +2.9420, -1.0000],  # Tl
            [+0.0000, +0.9383, +1.9356, +2.9081, +3.9098],  # Pb
            [+0.0000, +0.9820, +1.9655, +2.9500, -1.0000],  # Bi
            [+0.0000, +0.9815, +1.9639, -1.0000, -1.0000],  # Po
            [+0.0000, +0.9954, -1.0000, -1.0000, -1.0000],  # At
            [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Rn
            [+0.0000, +0.9705, -1.0000, -1.0000, -1.0000],  # Fr
            [+0.0000, +0.9662, +1.8075, -1.0000, -1.0000],  # Ra
            [+0.0000, +2.9070, -1.0000, -1.0000, -1.0000],  # Ac
            [+0.0000, +2.8844, -1.0000, -1.0000, -1.0000],  # Th
            [+0.0000, +2.8738, -1.0000, -1.0000, -1.0000],  # Pa
            [+0.0000, +2.8878, -1.0000, -1.0000, -1.0000],  # U
            [+0.0000, +2.9095, -1.0000, -1.0000, -1.0000],  # Np
            [+0.0000, +1.9209, -1.0000, -1.0000, -1.0000],  # Pu
        ],
        dtype=dtype,
    )


def _load_c6(dtype=jnp.float32) -> Array:
    return jnp.array(
        jnp.load(op.join(op.dirname(__file__), "reference-c6.npy")),
        dtype=dtype,
    )


class Reference:
    """
    Reference dispersion coefficients and coordination numbers.

    Example
    -------
    >>> numbers = jnp.array([8, 1, 1, 8, 1, 6, 1, 1, 1])
    >>> numbers, species = jnp.unique(numbers, return_inverse=True)
    >>> ref = Reference.from_numbers(numbers)
    >>> ref.cn.shape, ref.c6.shape
    ((3, 5), (3, 3, 5, 5))
    >>> ref = ref[species]
    >>> ref.cn.shape, ref.c6.shape
    ((9, 5), (9, 9, 5, 5))
    """

    cn: Array
    """Reference coordination numbers"""

    c6: Array
    """Reference dispersion coefficients"""

    __slots__ = ["cn", "c6"]

    def __init__(self, cn, c6):
        self.cn = cn
        self.c6 = c6

    @classmethod
    def from_numbers(cls, numbers: Array, dtype=jnp.float32) -> "Reference":
        """
        Create a reference from a list of atomic numbers.

        Parameters
        ----------
        numbers : Array
            Atomic numbers.
        dtype : dtype, optional
            Data type of the arrays.

        Returns
        -------
        Reference
            Dispersion coefficients and coordination numbers.
        """

        return cls(_load_cn(dtype=dtype), _load_c6(dtype=dtype))[numbers]

    def __getitem__(self, item: Array) -> "Reference":
        """
        Get a subset of the reference.

        Parameters
        ----------
        item : Array
            Atomic numbers.

        Returns
        -------
        Reference
            Dispersion coefficients and coordination numbers.
        """

        return Reference(
            self.cn[item, :],
            self.c6[item.reshape(-1, 1), item.reshape(1, -1), :, :],
        )
